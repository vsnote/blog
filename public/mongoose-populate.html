<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.16" />


<title>Mongoose populate 预填充字段 - 陈三</title>
<meta property="og:title" content="Mongoose populate 预填充字段 - 陈三">



  






<link rel="stylesheet" href="https://www.zfanw.com/blog/css/main.css" media="all">

  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="https://www.zfanw.com/blog/" class="nav-logo">陈三</a>

  <ul class="nav-links">
    
    <li><a href="/blog/">Home</a></li>
    
    <li><a href="/blog/about/">关于</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">1 min read</span>
    

    <h1 class="article-title">Mongoose populate 预填充字段</h1>

    
    <span class="article-date">May 5, 2016</span>
    

    <div class="article-content">
      

<p>举这个博客说，它有两个模型（model），<code>User</code> 和 <code>Post</code>。</p>

<p>一个 User 可以有多篇 Post，创建 Post 的时候，我们要存一个作者信息，假定是 <code>author</code> 字段，它的值指向用户的 <code>_id</code>。</p>

<pre><code>var mongoose = require('mongoose')
  , Schema = mongoose.Schema
var userSchema = Schema({
  name: String
})
var postSchema = Schema({
  title: String,
  content: String,
  author: String
})
var User = mongoose.model('User', userSchema)
var Post = mongoose.model('Post', postSchema)
</code></pre>

<p>以上是我还不知道 <code>populate</code> 时的写法，<code>Post</code> 模型里，<code>author</code> 指向了用户的 <code>_id</code>，这样，每次查询 post 都需要查询两个模型：</p>

<pre><code>Post.findOne({title: 'mongoose populate'}).then((doc) =&gt; {
  User.findOne({_id: doc.author}).then((user) =&gt; {
    return Object.assign({}, doc, {author: user})
  })
})
</code></pre>

<p>但 mongoose 提供了 <code>populate</code> 方法，可以在查询时，预先填充字段：</p>

<pre><code>var mongoose = require('mongoose')
  , Schema = mongoose.Schema
var userSchema = Schema({
  name: String
})
// 这里，我们给 author 定义了一个 `ref` 指向了 User 模型
var postSchema = Schema({
  title: String,
  content: String,
  author: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'User'
  }
})
// `findOne` 勾子，在使用 `findOne` 时，mongoose 会预填充 `author` 字段的数据
postSchema.pre('findOne', function (next) {
  this.populate('author', 'name')
  next()
})
var User = mongoose.model('User', userSchema)
var Post = mongoose.model('Post', postSchema)
</code></pre>

<p>我们的查询 post 语句可以写成这样：</p>

<pre><code>Post.findOne({title: 'mongoose populate'}).then((doc) =&gt; {
  return doc
})
</code></pre>

<p>其中 <code>doc</code> 里的 <code>author</code> 是一个对象，包含一个 <code>_id</code> 和一个 <code>name</code>，非常便捷、简洁。</p>

<h2 id="参考">参考</h2>

<ol>
<li><a href="http://mongoosejs.com/docs/populate.html">Mongoose Query Population v4.4.16</a></li>
</ol>

    </div>
  </article>

  

</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="https://www.zfanw.com/blog/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with Hugo</a>
          </li>
        </ul>
      </footer>

    </div>

    
  </body>
</html>

