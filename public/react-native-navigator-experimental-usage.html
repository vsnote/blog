<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.16" />


<title>react-native Navigation Experimental 怎么用 - 陈三</title>
<meta property="og:title" content="react-native Navigation Experimental 怎么用 - 陈三">



  






<link rel="stylesheet" href="https://www.zfanw.com/blog/css/main.css" media="all">

  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="https://www.zfanw.com/blog/" class="nav-logo">陈三</a>

  <ul class="nav-links">
    
    <li><a href="/blog/">Home</a></li>
    
    <li><a href="/blog/about/">关于</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">3 min read</span>
    

    <h1 class="article-title">react-native Navigation Experimental 怎么用</h1>

    
    <span class="article-date">June 6, 2016</span>
    

    <div class="article-content">
      <p><strong>说明</strong>：本文基于 react-native 0.29.0-rc.0，仅针对 iOS 平台。</p>

<p>react-native 的 navigation experimental 是 <a href="https://facebook.github.io/react-native/docs/navigator.html">navigator</a> 的继任，但因为还在开发中，目前没什么文档，API 也经常变动，示例没跟上，就让人看不懂。</p>

<p>在 navigation experimental 下，<a href="https://github.com/facebook/react-native/blob/master/Examples/UIExplorer/NavigationExperimental/NavigationCardStack-NavigationHeader-Tabs-example.js#L53">路由只是些对象</a>：</p>

<pre><code>function createAppNavigationState(): Object {
  return  {
    // Three tabs.
    tabs: {
      index: 0,
      routes: [
        {key: 'apple'},
        {key: 'banana'},
        {key: 'orange'},
      ],
    },
    // Scenes for the `apple` tab.
    apple: {
      index: 0,
      routes: [{key: 'Apple Home'}],
    },
    // Scenes for the `banana` tab.
    banana: {
      index: 0,
      routes: [{key: 'Banana Home'}],
    },
    // Scenes for the `orange` tab.
    orange: {
      index: 0,
      routes: [{key: 'Orange Home'}],
    },
  };
}
</code></pre>

<p>上面的路由表示 app 有三个标签页，每个标签页各有各的子路由。</p>

<p>我们不妨把路由想成一个族谱（family tree），循着每个树枝，我们能抵达到各个页面。而 <code>index</code> 就是我们的指路牌。我们的页面间的切换，就是<a href="https://github.com/facebook/react-native/blob/master/Examples/UIExplorer/NavigationExperimental/NavigationCardStack-NavigationHeader-Tabs-example.js#L84">一个 action 修改 navigation state 的副作用</a>。</p>

<p>有了路由数据，就可以渲染对应的 scene 了，怎么做？</p>

<p>我们来写一个简单页面，它的路由数据是这样：</p>

<pre><code>{
  index: 0,
  routes: [{
    key: 'Want Home'
  }]
}
</code></pre>

<p>我们只有一个页面，<code>index</code> 值表示这个页面处于激活状态中。</p>

<p>页面组件如下：</p>

<pre><code>'use strict'
import React from 'react'
import { View, Text, NavigationExperimental } from 'react-native'
const {
  CardStack: NavigationCardStack,
  Header: NavigationHeader,
  PropTypes: NavigationPropTypes,
  StateUtils: NavigationStateUtils,
} = NavigationExperimental
class Want extends React.Component {
  renderScene = (sceneProps) =&gt; {
    return (
      &lt;View style={{flex: 1, marginTop: 64}}&gt;
        &lt;Text&gt;haha&lt;/Text&gt;
      &lt;/View&gt;
    )
  }
  render () {
    return (
      &lt;NavigationCardStack
        direction='vertical'
        navigationState={{
          index: 0,
          routes: [{
            key: 'Want Home'
          }]
        }}
        renderScene={this.renderScene}
        /&gt;
    )
  }
}
export default Want
</code></pre>

<p>刷新 Simulator，我们能看到 <code>haha</code> 文本，如果你用的是 react-native 0.28 版本，还会看到如下的错误：</p>

<blockquote>
<p>ExceptionsManager.js:70 Warning: Failed propType: Required prop <code>onNavigate</code> was not specified in <code>NavigationCardStack</code>. Check the render method of <code>Want</code>.</p>
</blockquote>

<p>而在 0.29 中，<code>onNavigate</code> <a href="https://github.com/facebook/react-native/commit/fb0007d85323909ab652bf97166744fa7e17daab">被移除了</a>，更换为 <code>onNavigateBack</code>。</p>

<p>如果想给页面定义个 navigationBar，我们可以添加一个 <code>renderOverlay</code>：</p>

<pre><code>  renderOverlay = (sceneProps) =&gt; {
    return (
      &lt;NavigationHeader
        {...sceneProps}
        renderTitleComponent={() =&gt; (
          &lt;NavigationHeader.Title&gt;
            想吃
          &lt;/NavigationHeader.Title&gt;
        )}
        /&gt;
    )
  }
  render () {
    return (
      &lt;NavigationCardStack
        direction='vertical'
        navigationState={{
          index: 0,
          routes: [{
            key: 'Want Home'
          }]
        }}
        renderScene={this.renderScene}
        renderOverlay={this.renderOverlay}
        /&gt;
    )
  }
</code></pre>

<p>刷新 simulator，我们能看到这样的界面：</p>

<p><a href="https://www.zfanw.com/blog/wp-content/uploads/2016/06/Screen-Shot-2016-06-21-at-23.10.14.png"><img src="https://www.zfanw.com/blog/wp-content/uploads/2016/06/Screen-Shot-2016-06-21-at-23.10.14.png" alt="react native navigator experimental" width="760" class="alignnone size-full wp-image-18582" srcset="https://www.zfanw.com/blog/wp-content/uploads/2016/06/Screen-Shot-2016-06-21-at-23.10.14.png 760w, https://www.zfanw.com/blog/wp-content/uploads/2016/06/Screen-Shot-2016-06-21-at-23.10.14-300x105.png 300w, https://www.zfanw.com/blog/wp-content/uploads/2016/06/Screen-Shot-2016-06-21-at-23.10.14-100x35.png 100w" sizes="(max-width: 760px) 100vw, 760px" /></a></p>

<p>目前我们还只有一个页面，没有路由切换，也没有动画效果。</p>

<p>假定我们点击了 haha 文本会进入详情页面。</p>

<p>在点击发生时，我们需要调整路由数据。</p>

<p>我们要用到 <a href="https://github.com/reactjs/redux">redux</a>。</p>

<p>先创建一个 <code>navigation.js</code> 的 reducer 文件，把上面的路由数据迁移过来：</p>

<pre><code>import { PUSH_ROUTE, POP_ROUTE } from '../actionTypes'
import { NavigationExperimental } from 'react-native'
const {StateUtils: NavigationStateUtils} = NavigationExperimental

const initialState = {
  index: 0,
  routes: [{
    key: 'Want Home'
  }]
}

function navigationState (state = initialState, action) {
  switch (action.type) {
    case PUSH_ROUTE:
      if (state.routes[state.index].key === (action.route &amp;&amp; action.route.key)) return state
      return NavigationStateUtils.push(state, action.route)

    case POP_ROUTE:
      if (state.index === 0 || state.routes.length === 1) return state
      return NavigationStateUtils.pop(state)

    default:
      return state

  }
}

export default navigationState
</code></pre>

<p>再添加一个 <code>navigation.js</code> 的 action 文件：</p>

<pre><code>import { PUSH_ROUTE, POP_ROUTE } from '../actionTypes'

export function push (route) {
  return {
    type: PUSH_ROUTE,
    route: route
  }
}

export function pop () {
  return {
    type: POP_ROUTE
  }
}
</code></pre>

<p>在 <code>Want</code> 组件中，我们通过 react-redux 提供的 <code>connect</code> 绑定 store 里的数据：</p>

<pre><code>'use strict'
import React from 'react'
import { View, Text, NavigationExperimental, TouchableHighlight } from 'react-native'
import { connect } from 'react-redux'
import { push, pop } from '../actions/navigation'
const {
  CardStack: NavigationCardStack,
  Header: NavigationHeader,
  PropTypes: NavigationPropTypes,
  StateUtils: NavigationStateUtils,
} = NavigationExperimental
class Want extends React.Component {
  goDetail = () =&gt; {
    this.props.dispatch(push({
      key: 'Want Detail'
    }))
  }
  renderScene = (sceneProps) =&gt; {
    // 我们在这里通过 key 渲染不同组件，这里只是简单展示同一个组件
    return (
      &lt;View style={{flex: 1, marginTop: 64}}&gt;
        &lt;TouchableHighlight onPress={this.goDetail}
          &gt;&lt;Text&gt;haha&lt;/Text&gt;
        &lt;/TouchableHighlight&gt;
      &lt;/View&gt;
    )
  }
  renderOverlay = (sceneProps) =&gt; {
    return (
      &lt;NavigationHeader
        {...sceneProps}
        renderTitleComponent={() =&gt; (
          &lt;NavigationHeader.Title&gt;
            想吃
          &lt;/NavigationHeader.Title&gt;
        )}
        /&gt;
    )
  }
  render () {
    return (
      &lt;NavigationCardStack
        direction='vertical'
        navigationState={this.props.navigation}
        renderScene={this.renderScene}
        renderOverlay={this.renderOverlay}
        /&gt;
    )
  }
}
const mapStateToProps = (state) =&gt; ({
  navigation: state.navigation
})
export default connect(mapStateToProps)(Want)
</code></pre>

<p>这样，我们就有了一个简陋的页面切换：</p>

<p><a href="https://www.zfanw.com/blog/wp-content/uploads/2016/06/react-native-navigator.gif"><img src="https://www.zfanw.com/blog/wp-content/uploads/2016/06/react-native-navigator.gif" alt="react-native-navigator" width="372" class="alignnone size-full wp-image-18588" /></a></p>

<p>Chrome 控制台中的 log 如下：</p>

<p><a href="https://www.zfanw.com/blog/wp-content/uploads/2016/06/Screen-Shot-2016-06-22-at-11.16.27.png"><img src="https://www.zfanw.com/blog/wp-content/uploads/2016/06/Screen-Shot-2016-06-22-at-11.16.27.png" alt="Screen Shot 2016-06-22 at 11.16.27" width="1400" class="alignnone size-full wp-image-18590" srcset="https://www.zfanw.com/blog/wp-content/uploads/2016/06/Screen-Shot-2016-06-22-at-11.16.27.png 1400w, https://www.zfanw.com/blog/wp-content/uploads/2016/06/Screen-Shot-2016-06-22-at-11.16.27-300x196.png 300w, https://www.zfanw.com/blog/wp-content/uploads/2016/06/Screen-Shot-2016-06-22-at-11.16.27-768x502.png 768w, https://www.zfanw.com/blog/wp-content/uploads/2016/06/Screen-Shot-2016-06-22-at-11.16.27-1024x670.png 1024w, https://www.zfanw.com/blog/wp-content/uploads/2016/06/Screen-Shot-2016-06-22-at-11.16.27-100x65.png 100w" sizes="(max-width: 1400px) 100vw, 1400px" /></a></p>

<p>上面的动画里可以看到，虽然我们没有给 <code>Want Detail</code> 添加返回键，它默认却是已经有了。但是我们如果点击返回键，是没有效果的。</p>

<p>我们需要给 <code>NavigationHeader</code> 添加一个 <code>onNavigateBack</code>，它定义了用户点击返回键时的效果：</p>

<pre><code>      &lt;NavigationHeader
        {...sceneProps}
        onNavigateBack={
          () =&gt; this.props.dispatch(pop())
        }
        renderTitleComponent={() =&gt; (
          &lt;NavigationHeader.Title&gt;
            想吃
          &lt;/NavigationHeader.Title&gt;
        )}
        /&gt;
</code></pre>

<p>结果如下图：</p>

<p><a href="https://www.zfanw.com/blog/wp-content/uploads/2016/06/react-native-navigator-with-back.gif"><img src="https://www.zfanw.com/blog/wp-content/uploads/2016/06/react-native-navigator-with-back.gif" alt="react-native-navigator-with-back" width="372" class="alignnone size-full wp-image-18595" /></a></p>

    </div>
  </article>

  

</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="https://www.zfanw.com/blog/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with Hugo</a>
          </li>
        </ul>
      </footer>

    </div>

    
  </body>
</html>

