<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.16" />


<title>React.js 动画 - 陈三</title>
<meta property="og:title" content="React.js 动画 - 陈三">



  






<link rel="stylesheet" href="https://www.zfanw.com/blog/css/main.css" media="all">

  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="https://www.zfanw.com/blog/" class="nav-logo">陈三</a>

  <ul class="nav-links">
    
    <li><a href="/blog/">Home</a></li>
    
    <li><a href="/blog/about/">关于</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">1 min read</span>
    

    <h1 class="article-title">React.js 动画</h1>

    
    <span class="article-date">September 9, 2015</span>
    

    <div class="article-content">
      

<p>我猜你看过 <a href="https://facebook.github.io/react/docs/animation.html">React.js 动画</a>的文档，并且不下三遍。</p>

<p>我看了不下十遍，还是觉得 <a href="https://github.com/facebook/react/blob/master/src/addons/transitions/ReactCSSTransitionGroupChild.js" title="源代码">ReactCSSTransitionGroup</a> 这 high-level API 跟魔法似的，另外，<a href="https://github.com/facebook/react/search?q=ReactCSSTransitionGroup&amp;type=Issues&amp;utf8=✓">奇奇怪怪的 bug</a> 还不少。</p>

<p>最后我决定试试更底层的 <a href="https://facebook.github.io/react/docs/animation.html#low-level-api-reacttransitiongroup">TransitionGroup</a>。</p>

<p>TransitionGroup 定义了动画组件的六个生命周期：</p>

<ol>
<li>componentWillAppear(callback)</li>
<li>componentDidAppear()</li>
<li>componentWillEnter(callback)</li>
<li>componentDidEnter()</li>
<li>componentWillLeave(callback)</li>
<li>componentDidLeave()</li>
</ol>

<p>如果你了解 componentDidMount 等，则这六个生命周期的概念是相近的，只不过，它们是动画组件才会有的。</p>

<p>简单说，一个 TransitionGroup 容器中的组件，在它：</p>

<ol>
<li>加入容器</li>
<li>或是从容器中移除</li>
</ol>

<p>就会经历以上 6 个生命周期。</p>

<p>我们操纵它在这些生命周期中的样式，也就产生了动画。</p>

<p>来看一个简单模样：</p>

<pre><code>  render () {
    let todos = this.state.todos.map((todo, index) =&gt; {
      return (
         &lt;Animation key={index}&gt;&lt;li&gt;{todo}&lt;/li&gt;&lt;/Animation&gt;
      )
    })
    return (
        &lt;ReactTransitionGroup component='ul'&gt;
          {todos}
        &lt;/ReactTransitionGroup&gt;
    )
  }
</code></pre>

<p>ReactTransitionGroup 是容器，Animation 是容器中的元素。</p>

<p>之所以要有一个 Animation 组件包装真正的元素，只是我为了便于代码复用。</p>

<p>Animation 组件中，componentWillEnter 周期中的代码是这样的（<strong>注意，这是我理想中的版本</strong>，具体情况见文末链接）：</p>

<pre><code>  componentWillEnter (cb) {
    let el = React.findDOMNode(this)
    el.classList.add(styles.enter)
    requestAnimationFrame(() =&gt; {
      el.classList.add(styles.active)
    })
    el.addEventListener('transitionend', () =&gt; {
      if (cb) cb()
    el.classList.remove(styles.enter)
    el.classList.remove(styles.active)
    })
  }
</code></pre>

<p>我们在 <strong>componentWillEnter</strong> 里给 Animation 组件添加了 styles.enter 样式类，然后在浏览器下一个 tick 加入 styles.active 样式类 &#8211; 这里使用了 requestAnimationFrame，也可以使用 setTimeout，另外我们还监听 &#8216;transitionend&#8217; 事件，transitionend 事件发生时执行回调 cb 并移除 styles.enter 与 styles.active 两个样式类（如果不了解这一种样式用法，请参见 <a href="https://www.zfanw.com/blog/css-modularize.html">CSS 模块化</a>）。</p>

<p>相应的 CSS 文件：</p>

<pre><code>.enter {
  opacity: 0;
}
.enter.active {
  opacity: 1;
  transition: opacity 0.5s ease-in;
}
</code></pre>

<p>当然，现实比较刺人，transitionend 事件并不稳定、时有时没有，所以我写的真实的代码其实是<a href="https://github.com/chenxsan/demo-jest-test-flux-store/blob/master/src/animation/Animation.js" title="访问 github">这样</a>，它基于 khan Academy 的 <a href="https://github.com/Khan/react-components/blob/master/js/timeout-transition-group.jsx">timeout-transition-group</a> 组件做了改造，最后的动画效果请点击<a href="https://www.zfanw.com/react/demo-store-test/">示例</a>查看。</p>

<p>不过据说，我们有望在 react.js 0.14 中用上可靠的 <a href="https://github.com/facebook/react/pull/4561">ReactCSSTransitionGroup</a> &#8211; 现在是 react.js 0.14 rc 1。</p>

<p>谢天谢地。<div class=timeline></p>

<h2 id="p-s">P.S</h2>

<ol>
<li>2015-10-02 可以尝试 twitter fabric 团队出的 <a href="https://github.com/twitter-fabric/velocity-react">velocity-react</a></li>

<li><p>2015-10-11 <a href="http://facebook.github.io/react/blog/2015/10/07/react-v0.14.html">react.js 0.14 正式版本</a>已经发布，其中动画部分说明如下：</p>

<blockquote>
<p>To improve reliability, CSSTransitionGroup will no longer listen to transition events. Instead, you should specify transition durations manually using props such as transitionEnterTimeout={500}.</div></p>
</blockquote></li>
</ol>

    </div>
  </article>

  

</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="https://www.zfanw.com/blog/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with Hugo</a>
          </li>
        </ul>
      </footer>

    </div>

    
  </body>
</html>

