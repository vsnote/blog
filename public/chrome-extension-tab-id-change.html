<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.16" />


<title>Chrome扩展开发中的标签页id变化 - 陈三</title>
<meta property="og:title" content="Chrome扩展开发中的标签页id变化 - 陈三">



  






<link rel="stylesheet" href="https://www.zfanw.com/blog/css/main.css" media="all">

  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="https://www.zfanw.com/blog/" class="nav-logo">陈三</a>

  <ul class="nav-links">
    
    <li><a href="/blog/">Home</a></li>
    
    <li><a href="/blog/about/">关于</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">1 min read</span>
    

    <h1 class="article-title">Chrome扩展开发中的标签页id变化</h1>

    
    <span class="article-date">May 5, 2014</span>
    

    <div class="article-content">
      <p>如果你认为，Chrome浏览器中，每一个标签页的id是唯一的，且打开时是不变的。那么你是对的。</p>

<p>但在我的开发过程中，却出现tab id发生变化的情况。</p>

<p>整个过程是大概这样的：</p>

<ol>
<li><p>background.js监控到页面上的点击事件，创建一个新标签页，并将新标签页的id值赋给一个全局变量taskTab：</p>

<pre><code>var taskTab;
chrome.tabs.create({url: 'http://www.zfanw.com/blog/}, function(tab) {
taskTab = tab.id;
});
</code></pre></li>

<li><p>同时，在background.js里监听webNavigation的onCommitted事件，用于动态注入内容脚本：</p>

<pre><code>chrome.webNavigation.onCommitted.addListener(function(details) {
if (details.tabId === taskTab) {
    chrome.tabs.executeScripts(taskTab, {file: 'example.js'}); 
}
});
</code></pre></li>
</ol>

<p>在新标签页打开并注入内容脚本后，内容脚本会找出页面里的链接&#8221;<a href="http://www.zfanw.com/blog/about&amp;#8221;，并模拟点击。">http://www.zfanw.com/blog/about&amp;#8221;，并模拟点击。</a></p>

<p>且假定新标签页页面HTML代码中还包含如下内容：</p>

<pre><code>&lt;link rel=&quot;prerender&quot; href=&quot;http://www.zfanw.com/blog/about&quot;&gt;
</code></pre>

<p>prerender<sup class="footnote-ref" id="fnref:12710-1"><a rel="footnote" href="#fn:12710-1">1</a></sup>是Chrome浏览器的一个加速访问的特性。它可以在我们访问A页面时，先在背景加载好B页面，这样我们访问B页面时，就非常神速。</p>

<p>摘取链接1中的一段描述：</p>

<blockquote>
<p>A hidden page is created for the prerendered URL, which will do full loading of all dependent resources, as well as execution of Javascript. If the user navigates to the page, the hidden page will be swapped into the current tab and made visible.</p>
</blockquote>

<p>B页面是在一个隐藏页中加载的，当我们点击B链接时，隐藏页就替入当前标签页并置为可见。</p>

<p>从字面上看，没有任何字眼暗示说tab id会变化。</p>

<p>但实际上，tab id确实变了，这可以在background.js里绑定一个onReplaced事件来检查。</p>

<p>onReplaced<sup class="footnote-ref" id="fnref:12710-2"><a rel="footnote" href="#fn:12710-2">2</a></sup>事件描述如下：</p>

<blockquote>
<p>Fired when the contents of the tab is replaced by a different (usually previously pre-rendered) tab.</p>
</blockquote>

<p>绑定的代码如下：</p>

<pre><code>chrome.tabs.onReplaced.addListener(function(addedTabId, removedTabId) {
  console.log &quot;added tabid: &quot; + addedTabId;
  console.log &quot;removed tabid: &quot; + removedTabId;
  });
</code></pre>

<p>打开背景页的开发者工具，我们就能看到，模拟的点击事件发生时，Chrome浏览器移除了一个标签页，并新增了一个。只是从我们肉眼来说，根本看不到置换过程。</p>

<p>我的情况里，因为tab id变化，所以taskTab的值其实已经没用，结果导致点击打开的about页面没能注入内容脚本。如果你也碰上内容脚本动态注入失败的情况，不妨检查下标签页的id值。</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:12710-1"><a href="http://www.chromium.org/developers/design-documents/prerender">Chrome Prerendering &#8211; The Chromium Projects</a>
 <a class="footnote-return" href="#fnref:12710-1"><sup>[return]</sup></a></li>
<li id="fn:12710-2"><a href="https://developer.chrome.com/extensions/webNavigation#event-onTabReplaced">chrome.webNavigation &#8211; Google Chrome</a>
 <a class="footnote-return" href="#fnref:12710-2"><sup>[return]</sup></a></li>
</ol>
</div>

    </div>
  </article>

  

</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="https://www.zfanw.com/blog/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with Hugo</a>
          </li>
        </ul>
      </footer>

    </div>

    
  </body>
</html>

